как это работает? опиши всю логику, с триалом, защиты от подмены ремени и Привязка к устройству (HWID / machine fingerprint) так же мне нужно чтобы пользователь видел сколько у него оставалась времени триала, шел обратный отсчет в секундах когда программа запущена, так же для всех лицензий нужен обратный таймер - для просмотра лицензий как происходит запрос к срверу для обновления информации?

```txt
1. Общая логика heartbeat (POST /api/joy/heartbeat)
Это сердцебиение программы. Оно отправляется каждую минуту, пока программа запущена.
Что приходит от клиента:

token — JWT-токен пользователя
minutesUsed — сколько минут прошло с прошлого heartbeat (обычно 1)
deviceId — уникальный отпечаток компьютера (HWID)

Что делает сервер:
Шаг 1. Проверка токена
TypeScriptpayload = await verifyLicenseToken(token)

Если токен подделан/просрочен → 401 Invalid token

Шаг 2. Поиск лицензии
Ищет лицензию по payload.lic (id лицензии, который зашит в токене).
Шаг 3. Основные проверки безопасности
A. Активна ли лицензия вообще?

!license или !license.isActivated или !license.isCurrent → 403 License not active

B. Привязка к устройству (HWID protection)
TypeScriptif (license.subscriptionType !== 'trial' && 
    license.deviceId && 
    license.deviceId !== deviceId) {
    return 403 'HWID mismatch'
}

Только для платных лицензий (не trial).
Если в базе уже записан deviceId, а пришёл другой — запрет.
При первом использовании платной лицензии (когда deviceId в БД ещё пустой) — в /validate происходит авто-привязка.

Шаг 4. Специальная логика для триала
Только если subscriptionType === 'trial':

Проверяет, новый ли сегодня день:TypeScriptif (license.lastUsageDate.toDateString() !== now.toDateString()) {
    used = 0;   // сброс счётчика
}
Прибавляет minutesUsed (обычно +1)
Если превышен лимит (used > trialMinutesLimit) → 403 Daily trial limit reached
Сохраняет в базу:
trialMinutesUsed
lastUsageDate = now
deviceId (если прислали)


Защита от подмены времени (time manipulation)
Что сейчас защищено:

Сброс триала происходит по календарному дню (toDateString()), а не по количеству часов.
Сервер всегда использует своё время (new Date()).

Что НЕ защищено:

Пользователь может изменить системное время на компьютере → триал "продлится" дольше.
Нет проверки разницы между временем клиента и сервера.

Как усилить (если нужно):
Можно добавить проверку:
TypeScriptconst timeDiff = Math.abs(now.getTime() - new Date(lastUsageDate).getTime());
if (timeDiff > 86400000 * 2) { // больше 2 дней разницы
    // подозрительно — можно сбросить или заблокировать
}

Как обновляется информация в приложении C#?
Сейчас у тебя два разных запроса:

ЗапросКогда вызываетсяЧто возвращаетОбновляет что в приложении/validateПри запуске + кнопка "Обновить"Полный статус лицензииEmail, тип, дата окончания, остаток триала/heartbeatКаждую минутуТолько success, used, typeТолько usage для триала
Важно:
/heartbeat не обновляет полный статус лицензии (дату окончания, тип и т.д.). Он только тратит минуты триала.

```

